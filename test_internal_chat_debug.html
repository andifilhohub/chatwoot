<!DOCTYPE html>
<html>
<head>
    <title>Teste Chat Interno - Debug</title>
    <meta charset="utf-8">
</head>
<body>
    <h1>Teste Chat Interno - Debug</h1>
    
    <div>
        <h3>Enviar Mensagem</h3>
        <textarea id="messageContent" placeholder="Digite sua mensagem..." style="width: 300px; height: 100px;">Teste de mensagem simples</textarea>
        <br><br>
        
        <label>Room Type:</label>
        <select id="roomType">
            <option value="general">General</option>
            <option value="direct">Direct</option>
        </select>
        <br><br>
        
        <label>Room ID:</label>
        <input type="text" id="roomId" value="general" placeholder="ID da sala">
        <br><br>
        
        <button onclick="sendMessage()">Enviar Mensagem</button>
        <button onclick="loadMessages()">Carregar Mensagens</button>
        <button onclick="testConnection()">Testar Conex√£o</button>
    </div>
    
    <div id="result" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc; background: #f9f9f9;">
        <h3>Resultado:</h3>
        <pre id="resultText"></pre>
    </div>
    
    <div id="messages" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc; background: #f0f0f0;">
        <h3>Mensagens:</h3>
        <pre id="messagesText"></pre>
    </div>

    <script>
        const API_BASE = '/api/v1/accounts/1/internal_chat';
        
        function log(message) {
            console.log(message);
            document.getElementById('resultText').textContent += message + '\n';
        }
        
        function logMessages(message) {
            console.log(message);
            document.getElementById('messagesText').textContent += message + '\n';
        }
        
        async function sendMessage() {
            const content = document.getElementById('messageContent').value;
            const roomType = document.getElementById('roomType').value;
            const roomId = document.getElementById('roomId').value;
            
            log(`üì§ Enviando mensagem: "${content}" para ${roomType}/${roomId}`);
            
            try {
                const response = await fetch(`${API_BASE}/send_message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || ''
                    },
                    body: JSON.stringify({
                        message: {
                            content: content,
                            room_type: roomType,
                            room_id: roomId
                        }
                    })
                });
                
                log(`üì° Response status: ${response.status}`);
                log(`üì° Response headers: ${JSON.stringify([...response.headers.entries()])}`);
                
                const data = await response.text();
                log(`üì° Response body: ${data}`);
                
                if (response.ok) {
                    log('‚úÖ Mensagem enviada com sucesso!');
                } else {
                    log(`‚ùå Erro ao enviar mensagem: ${response.status}`);
                }
                
            } catch (error) {
                log(`‚ùå Erro na requisi√ß√£o: ${error.message}`);
            }
        }
        
        async function loadMessages() {
            const roomType = document.getElementById('roomType').value;
            const roomId = document.getElementById('roomId').value;
            
            logMessages(`üì® Carregando mensagens para ${roomType}/${roomId}`);
            
            try {
                let url;
                if (roomType === 'general') {
                    url = `${API_BASE}/messages/general`;
                } else {
                    url = `${API_BASE}/messages/${roomType}/${roomId}`;
                }
                
                logMessages(`üì° URL: ${url}`);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || ''
                    }
                });
                
                logMessages(`üì° Response status: ${response.status}`);
                
                const data = await response.text();
                logMessages(`üì° Response body: ${data}`);
                
                if (response.ok) {
                    logMessages('‚úÖ Mensagens carregadas com sucesso!');
                } else {
                    logMessages(`‚ùå Erro ao carregar mensagens: ${response.status}`);
                }
                
            } catch (error) {
                logMessages(`‚ùå Erro na requisi√ß√£o: ${error.message}`);
            }
        }
        
        async function testConnection() {
            log('üîå Testando conex√£o com ActionCable...');
            
            try {
                // Simular conex√£o ActionCable
                if (window.App && window.App.cable) {
                    log('‚úÖ ActionCable dispon√≠vel');
                    
                    const subscription = window.App.cable.subscriptions.create(
                        {
                            channel: 'InternalChatChannel',
                            account_id: 1
                        },
                        {
                            connected() {
                                log('‚úÖ Conectado ao ActionCable');
                            },
                            disconnected() {
                                log('‚ùå Desconectado do ActionCable');
                            },
                            received(data) {
                                log(`üì® Mensagem recebida via ActionCable: ${JSON.stringify(data)}`);
                            }
                        }
                    );
                    
                    log('üì° Subscription criada');
                } else {
                    log('‚ùå ActionCable n√£o dispon√≠vel');
                }
                
            } catch (error) {
                log(`‚ùå Erro na conex√£o: ${error.message}`);
            }
        }
        
        // Limpar logs
        function clearLogs() {
            document.getElementById('resultText').textContent = '';
            document.getElementById('messagesText').textContent = '';
        }
        
        // Adicionar bot√£o para limpar
        document.body.innerHTML += '<br><button onclick="clearLogs()">Limpar Logs</button>';
    </script>
</body>
</html>
